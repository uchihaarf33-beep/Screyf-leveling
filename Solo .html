<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark Leveling</title>
<style>
body { font-family: Arial, sans-serif; background:#1e1e1e; color:#f0f0f0; margin:0; padding:20px;}
h1,h2 { text-align:center; color:#ffcc00;}
.container { max-width:700px; margin:auto; background:#2e2e2e; padding:20px; border-radius:10px;}
button { padding:10px 15px; margin:5px; border:none; border-radius:5px; cursor:pointer;}
input[type="text"], input[type="number"] { width:55%; padding:5px; margin:3px; border-radius:5px; border:none;}
input[type="number"].timer { width:20%; }
textarea { width:100%; padding:5px; border-radius:5px; border:none;}
table { width:100%; border-collapse:collapse; margin-top:15px;}
th,td { border:1px solid #555; padding:8px; text-align:center;}
.alert { text-align:center; font-weight:bold; padding:10px; margin:10px 0; border-radius:5px;}
.boss { background:#ff9900; color:black;}
.taskRow { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.taskRow input[type="text"], .taskRow input[type="number"] { margin-right:5px; }
.timerDisplay { color:#ffcc00; font-weight:bold; margin-left:5px; }
@media (max-width: 600px) { .container { padding:10px; } button { width:100%; margin:5px 0; } input, textarea { width:100%; } }
</style>
</head>
<body>
<div class="container">
  <h1>Screyf RPG Tracker</h1>

  <!-- Task Settings -->
  <h2>Task Settings (Customizable, 5 Tasks)</h2>
  <div id="taskSettings"></div>
  <button onclick="saveTasks()">Save Task Settings</button>

  <!-- Punishment -->
  <h2>Punishment Settings</h2>
  <div>
    <textarea id="punishText" rows="2" placeholder="Define your punishment"></textarea><br>
    <button onclick="savePunishment()">Save Punishment</button>
  </div>

  <!-- Daily Tasks -->
  <h2>Daily Tasks</h2>
  <div id="dailyTasks"></div>

  <!-- Stats -->
  <h2>Stats</h2>
  <p>Total EXP: <span id="totalExp">0</span></p>
  <p>Level: <span id="level">1</span></p>

  <!-- Boss -->
  <h2>Weekly Boss Tracker</h2>
  <p id="bossStatus">Boss not yet challenged</p>
  <button class="boss" onclick="bossFight()">Challenge Boss</button>

  <!-- Daily Log -->
  <h2>Daily Log</h2>
  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Task</th>
        <th>Status</th>
        <th>EXP Change</th>
        <th>Level</th>
        <th>Punishment</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="alertBox"></div>
</div>

<script>
// ======== Initialization ========
let tasks = JSON.parse(localStorage.getItem('tasks')) || [
  {name:'Fitness', exp:50, timerMin:0, timerSec:0, startTime:null},
  {name:'IQ Challenge', exp:40, timerMin:0, timerSec:0, startTime:null},
  {name:'Goal Task', exp:30, timerMin:0, timerSec:0, startTime:null},
  {name:'Reading', exp:20, timerMin:0, timerSec:0, startTime:null},
  {name:'Skill Practice', exp:60, timerMin:0, timerSec:0, startTime:null}
];
let punishment = localStorage.getItem('punishment') || "50 push-ups + no phone/entertainment 2 hours";
let stats = JSON.parse(localStorage.getItem('stats')) || {totalExp:0, level:1};
let log = JSON.parse(localStorage.getItem('log')) || [];
let lastBossDate = localStorage.getItem('lastBossDate') || null;
let timers = [];

// ======== Render Task Settings ========
function renderTaskSettings(){
  const container = document.getElementById('taskSettings');
  container.innerHTML = '';
  tasks.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='taskRow';
    div.innerHTML = `
      <input type="text" id="taskName${i}" placeholder="Task Name" value="${t.name}">
      <input type="number" id="taskExp${i}" placeholder="EXP" value="${t.exp}">
      <input type="number" id="taskMin${i}" placeholder="Min" style="width:10%;" value="${t.timerMin}">
      :
      <input type="number" id="taskSec${i}" placeholder="Sec" style="width:10%;" value="${t.timerSec}">
    `;
    container.appendChild(div);
  });
}
renderTaskSettings();

// ======== Save Tasks ========
function saveTasks(){
  tasks = [];
  for(let i=0;i<5;i++){
    let name = document.getElementById(`taskName${i}`).value || `Task${i+1}`;
    let exp = parseFloat(document.getElementById(`taskExp${i}`).value) || 10;
    let min = parseInt(document.getElementById(`taskMin${i}`).value) || 0;
    let sec = parseInt(document.getElementById(`taskSec${i}`).value) || 0;
    tasks.push({name, exp, timerMin:min, timerSec:sec, startTime:null});
  }
  localStorage.setItem('tasks', JSON.stringify(tasks));
  renderDailyTasks();
  showAlert("âœ… Task Settings Saved", 'green');
}

// ======== Save Punishment ========
function savePunishment(){
  punishment = document.getElementById('punishText').value || "50 push-ups + no phone/entertainment 2 hours";
  localStorage.setItem('punishment', punishment);
  showAlert("âœ… Punishment Saved", 'green');
}

// ======== Render Daily Tasks ========
function renderDailyTasks(){
  const container = document.getElementById('dailyTasks');
  container.innerHTML = '';
  tasks.forEach((t,i)=>{
    const div = document.createElement('div');
    div.style.marginBottom='10px';
    div.style.fontSize='1.2em';
    let hasTimer = (t.timerMin>0 || t.timerSec>0);
    let timerButton = hasTimer ? `<button onclick="startTask(${i})">Start Timer</button> <span class="timerDisplay" id="timer${i}">${formatTime(getRemainingTime(i))}</span>` : '';
    div.innerHTML = `
      <label>
        <input type="checkbox" id="taskCheck${i}" style="width:20px;height:20px;margin-right:10px;"> ${t.name} (+${t.exp} EXP)
      </label>
      ${timerButton}
      <button onclick="submitTask(${i})">Submit Task</button>
    `;
    container.appendChild(div);
    if(hasTimer) resumeTimer(i);
  });
}

// ======== Start Task Timer ========
function startTask(i){
  clearInterval(timers[i]);
  const totalSec = tasks[i].timerMin*60 + tasks[i].timerSec;
  tasks[i].startTime = Date.now();
  tasks[i].durationSec = totalSec;
  localStorage.setItem('tasks', JSON.stringify(tasks));
  resumeTimer(i);
}

// ======== Resume Timer (Background support) ========
function resumeTimer(i){
  clearInterval(timers[i]);
  const display = document.getElementById(`timer${i}`);
  let remaining = getRemainingTime(i);
  display.innerText = formatTime(remaining);

  if(remaining <=0){
    autoMissTask(i);
    return;
  }

  timers[i] = setInterval(()=>{
    remaining = getRemainingTime(i);
    if(remaining<=0){
      clearInterval(timers[i]);
      autoMissTask(i);
      return;
    }
    display.innerText = formatTime(remaining);
  },1000);
}

// ======== Get Remaining Time ========
function getRemainingTime(i){
  const t = tasks[i];
  if(!t.startTime) return t.timerMin*60 + t.timerSec;
  const elapsed = Math.floor((Date.now() - t.startTime)/1000);
  const total = t.timerMin*60 + t.timerSec;
  const remain = total - elapsed;
  return remain>0 ? remain : 0;
}

// ======== Format Time ========
function formatTime(sec){
  let m = Math.floor(sec/60);
  let s = sec%60;
  return `${m}:${s<10?'0'+s:s}`;
}

// ======== Auto Miss Task ========
function autoMissTask(i){
  document.getElementById(`taskCheck${i}`).checked=false;
  recordTask(i,false);
  showAlert(`â° Time's up! Task "${tasks[i].name}" missed. Punishment applied.`, 'red');
  tasks[i].startTime = null;
  localStorage.setItem('tasks', JSON.stringify(tasks));
}

// ======== Manual Submit Task ========
function submitTask(i){
  const checked = document.getElementById(`taskCheck${i}`).checked;
  recordTask(i,checked);
  clearInterval(timers[i]);
  tasks[i].startTime = null;
  localStorage.setItem('tasks', JSON.stringify(tasks));
  showAlert(`âœ… Task "${tasks[i].name}" submitted.`, 'green');
}

// ======== Record Task ========
function recordTask(i,completed){
  const today = new Date().toLocaleDateString();
  let status = completed ? 'Done':'Missed';
  let expChange = completed ? tasks[i].exp : -50;
  stats.totalExp += expChange;
  if(stats.totalExp<0) stats.totalExp=0;
  stats.level = Math.floor(stats.totalExp/1000)+1;
  log.push({date:today, task:tasks[i].name, status:status, exp:expChange, level:stats.level, punishment: status==='Missed'?punishment:'-'});
  localStorage.setItem('stats', JSON.stringify(stats));
  localStorage.setItem('log', JSON.stringify(log));
  updateStats();
  updateLogTable();
  renderDailyTasks();
}

// ======== Stats & Log ========
function updateStats(){
  document.getElementById('totalExp').innerText = stats.totalExp;
  document.getElementById('level').innerText = stats.level;
}
function updateLogTable(){
  const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
  tbody.innerHTML='';
  log.forEach(entry=>{
    const row = tbody.insertRow();
    row.insertCell(0).innerText = entry.date;
    row.insertCell(1).innerText = entry.task;
    row.insertCell(2).innerText = entry.status;
    row.insertCell(3).innerText = entry.exp;
    row.insertCell(4).innerText = entry.level;
    row.insertCell(5).innerText = entry.punishment;
  });
}

// ======== Boss Fight ========
function bossFight(){
  const today = new Date().toLocaleDateString();
  let dayDiff=0;
  if(lastBossDate){
    const last = new Date(lastBossDate);
    dayDiff = Math.floor((new Date()-last)/(1000*60*60*24));
  }
  if(dayDiff<7){
    showAlert('ðŸ›¡ï¸ Boss not ready yet! Wait 7 days.', 'orange');
    return;
  }
  const reward = 50;
  stats.totalExp += reward*tasks.length;
  stats.level = Math.floor(stats.totalExp/1000)+1;
  lastBossDate = new Date();
  localStorage.setItem('lastBossDate', lastBossDate);
  localStorage.setItem('stats', JSON.stringify(stats));
  showAlert(`ðŸ’¥ Boss Defeated! +${reward*tasks.length} EXP`, 'yellow');
  updateStats();
}

// ======== Alerts ========
function showAlert(msg,color){
  const box=document.getElementById('alertBox');
  box.innerText=msg;
  box.className='alert';
  box.style.background=color;
  setTimeout(()=>{box.innerText=''; box.style.background='none';},4000);
}

// ======== Export CSV ========
function exportCSV(){
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Date,Task,Status,EXP,Level,Punishment\n";
  log.forEach(row=>{
    csvContent += `${row.date},${row.task},${row.status},${row.exp},${row.level},${row.punishment}\n`;
  });
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href",encodedUri);
  const today = new Date().toLocaleDateString().replace(/\//g,'-');
  link.setAttribute("download",`screyf_rpg_log_${today}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ======== Initialize ========
updateStats();
updateLogTable();
renderDailyTasks();
</script>
</body>
</html>
